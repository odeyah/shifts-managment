<script>
	const { createApp } = Vue;

	createApp({
		data() {
			return {
				// Employee data
				employees: [
					'יוסי כהן',
					'רחל לוי',
					'משה אברהם',
					'שרה דוד',
					'דני מלכה',
					'מירי רוזן',
					'אבי שמש',
					'טלי ברון',
					'נתן גולד',
					'מיכל ברק',
					'רון שחר',
					'תמר נוי',
				],
				shifts: ['1', '2', 'צו פתוח'],
				selectedNoOfShifts: '',

				// Hebrew days
				shortHebrewDays: ["א'", "ב'", "ג'", "ד'", "ה'", "ו'", "ש'"],

				// Current state
				selectedEmployee: '',
				selectedShifts: [],
				currentDeadlineWeek: [],

				// Manager
				managerPasswordInput: '',
				managerPassword: 'Aa321321', // Change this
				isManager: false,
				showRequests: false,
				allRequests: {},

				// UI state
				loading: false,
				deadlineInfo: '',
			};
		},

		computed: {
			availableShifts() {
				return this.currentDeadlineWeek.flatMap((date, dayIndex) => {
					const hebrewDay = this.shortHebrewDays[dayIndex];
					const dateStr = `${hebrewDay} ${date.getDate()}/${date.getMonth() + 1}`;

					return [
						{
							id: `${dayIndex}-day`,
							dateStr,
							type: 'יום',
							dayIndex,
							shiftType: 'day',
						},
						{
							id: `${dayIndex}-night`,
							dateStr,
							type: 'לילה',
							dayIndex,
							shiftType: 'night',
						},
					];
				});
			},

			weekKey() {
				if (!this.currentDeadlineWeek || this.currentDeadlineWeek.length === 0) return 'current';
				const firstDate = this.currentDeadlineWeek[0];
				return `${firstDate.getFullYear()}-${firstDate.getMonth()}-${firstDate.getDate()}`;
			},
		},

		mounted() {
			this.updateDeadlineInfo();
			setInterval(this.updateDeadlineInfo, 60000); // Update every minute
		},

		methods: {
			// Employee methods
			loadEmployeeData() {
				if (!this.selectedEmployee) {
					this.selectedShifts = [];
					return;
				}

				try {
					const savedData = JSON.parse(localStorage.getItem('employeeRequests') || '{}');
					const weekData = savedData[this.weekKey] || {};
					this.selectedShifts = weekData[this.selectedEmployee] || [];
				} catch (error) {
					console.error('Error loading employee data:', error);
					this.selectedShifts = [];
				}
			},

			toggleShift(shiftId) {
				const index = this.selectedShifts.indexOf(shiftId);

				if (index > -1) {
					// Remove selection
					this.selectedShifts.splice(index, 1);
				} else {
					// Add selection if under limit
					if (this.selectedShifts.length < 3) {
						this.selectedShifts.push(shiftId);
					}
				}
			},

			async submitRequest() {
				if (!this.selectedEmployee) {
					alert('אנא בחרו שם קודם');
					return;
				}

				this.loading = true;

				try {
					// Simulate async operation
					await new Promise(resolve => setTimeout(resolve, 1000));

					if (this.selectedShifts.length === 0) {
						const confirmed = confirm('לא בחרתם משמרות לא זמינות. האם אתם זמינים לכל המשמרות?');
						if (!confirmed) {
							this.loading = false;
							return;
						}
					}

					this.saveEmployeeRequest();

					const message =
						this.selectedShifts.length === 0
							? 'הבקשה נשלחה בהצלחה! אתם זמינים לכל המשמרות.'
							: `הבקשה נשלחה בהצלחה! בחרתם ${this.selectedShifts.length} משמרות שאתם לא זמינים אליהן.`;

					alert(message);
				} finally {
					this.loading = false;
				}
			},

			saveEmployeeRequest() {
				try {
					const allRequests = JSON.parse(localStorage.getItem('employeeRequests') || '{}');

					if (!allRequests[this.weekKey]) {
						allRequests[this.weekKey] = {};
					}

					allRequests[this.weekKey][this.selectedEmployee] = [...this.selectedShifts];
					localStorage.setItem('employeeRequests', JSON.stringify(allRequests));
				} catch (error) {
					console.error('Error saving employee request:', error);
					alert('שגיאה בשמירת הבקשה');
				}
			},

			clearSelections() {
				if (confirm('האם אתם בטוחים שאתם רוצים לאפס את הבחירות?')) {
					this.selectedShifts = [];
				}
			},

			// Manager methods
			checkManagerAccess() {
				if (this.managerPasswordInput === this.managerPassword) {
					this.isManager = true;
					alert('התחברת בהצלחה כמנהל!');
				} else if (this.managerPasswordInput) {
					alert('סיסמה שגויה');
					this.managerPasswordInput = '';
				}
			},

			loadAllRequests() {
				try {
					const allRequests = JSON.parse(localStorage.getItem('employeeRequests') || '{}');
					this.allRequests = allRequests[this.weekKey] || {};
					this.showRequests = true;
				} catch (error) {
					console.error('Error loading requests:', error);
					this.allRequests = {};
					this.showRequests = true;
				}
			},

			async exportAllRequests() {
				if (!this.isManager) return;

				this.loading = true;

				try {
					const allRequests = JSON.parse(localStorage.getItem('employeeRequests') || '{}');
					const weekRequests = allRequests[this.weekKey] || {};

					let csvContent = 'שם,';

					// Create headers
					this.currentDeadlineWeek.forEach((date, index) => {
						const hebrewDay = this.shortHebrewDays[index];
						const dateStr = `${hebrewDay} ${date.getDate()}/${date.getMonth() + 1}`;
						csvContent += `${dateStr} יום,${dateStr} לילה,`;
					});
					csvContent = csvContent.slice(0, -1) + '\n';

					// Add employee data
					this.employees.forEach(employee => {
						const employeeShifts = weekRequests[employee] || [];
						csvContent += `${employee},`;

						this.currentDeadlineWeek.forEach((date, dayIndex) => {
							const dayId = `${dayIndex}-day`;
							const nightId = `${dayIndex}-night`;

							const dayStatus = employeeShifts.includes(dayId) ? 'לא זמין' : 'זמין';
							const nightStatus = employeeShifts.includes(nightId) ? 'לא זמין' : 'זמין';

							csvContent += `${dayStatus},${nightStatus},`;
						});

						csvContent = csvContent.slice(0, -1) + '\n';
					});

					// Copy to clipboard
					await navigator.clipboard.writeText(csvContent);
					alert('הנתונים הועתקו ללוח! תוכלו כעת להדביק אותם בגוגל שיטס.');
				} catch (error) {
					console.error('Export error:', error);
					alert('שגיאה בייצוא הנתונים');
				} finally {
					this.loading = false;
				}
			},

			clearAllData() {
				if (!this.isManager) return;

				if (confirm('האם אתם בטוחים שאתם רוצים לאפס את כל הנתונים? פעולה זו בלתי הפיכה!')) {
					try {
						localStorage.removeItem('employeeRequests');
						this.allRequests = {};
						this.showRequests = false;
						alert('כל הנתונים נמחקו בהצלחה!');
					} catch (error) {
						console.error('Error clearing data:', error);
						alert('שגיאה במחיקת הנתונים');
					}
				}
			},

			// Date utilities
			updateDeadlineInfo() {
				try {
					const now = new Date();
					const currentDay = now.getDay();
					const currentHour = now.getHours();

					// Check if passed deadline (Wednesday 10:00)
					const passedDeadline = currentDay > 3 || (currentDay === 3 && currentHour >= 10);

					let targetWeek;
					let deadlineDate;

					if (passedDeadline) {
						targetWeek = this.getWeekAfterNext();
						deadlineDate = this.getNextWednesday();
					} else {
						targetWeek = this.getNextWeekDates();
						deadlineDate = this.getThisWednesday();
					}

					this.currentDeadlineWeek = targetWeek;

					// Update deadline info
					// Update deadline info
					const timeLeft = deadlineDate.getTime() - now.getTime();
					const daysLeft = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
					const hoursLeft = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

					if (timeLeft > 0) {
						const weekType = passedDeadline ? 'השבוע שאחרי הבא' : 'השבוע הבא';
						this.deadlineInfo = `⏰ בקשות עבור ${weekType} | מועד אחרון: ${deadlineDate.toLocaleDateString(
							'he-IL',
						)} בשעה 10:00 (נותרו ${daysLeft} ימים ו-${hoursLeft} שעות)`;
					} else {
						this.deadlineInfo = `⏰ המועד אחרון עבר - בקשות חדשות הן עבור השבוע שאחרי הבא`;
					}

					// Reload employee data if needed
					if (this.selectedEmployee) {
						this.loadEmployeeData();
					}
				} catch (error) {
					console.error('Error updating deadline info:', error);
					this.deadlineInfo = 'טוען מידע על מועדים...';
				}
			},

			getNextWeekDates() {
				const today = new Date();
				const nextSunday = new Date(today);
				nextSunday.setDate(today.getDate() + (7 - today.getDay()));

				const dates = [];
				for (let i = 0; i < 7; i++) {
					const date = new Date(nextSunday);
					date.setDate(nextSunday.getDate() + i);
					dates.push(date);
				}
				return dates;
			},

			getWeekAfterNext() {
				const today = new Date();
				const weekAfterNextSunday = new Date(today);
				weekAfterNextSunday.setDate(today.getDate() + (14 - today.getDay()));

				const dates = [];
				for (let i = 0; i < 7; i++) {
					const date = new Date(weekAfterNextSunday);
					date.setDate(weekAfterNextSunday.getDate() + i);
					dates.push(date);
				}
				return dates;
			},

			getThisWednesday() {
				const today = new Date();
				const wednesday = new Date(today);
				const daysUntilWednesday = (3 - today.getDay() + 7) % 7;
				wednesday.setDate(today.getDate() + daysUntilWednesday);
				wednesday.setHours(10, 0, 0, 0);
				return wednesday;
			},

			getNextWednesday() {
				const thisWednesday = this.getThisWednesday();
				const nextWednesday = new Date(thisWednesday);
				nextWednesday.setDate(thisWednesday.getDate() + 7);
				return nextWednesday;
			},

			formatShiftForDisplay(shiftId) {
				const [dayIndex, shiftType] = shiftId.split('-');
				const hebrewDay = this.shortHebrewDays[parseInt(dayIndex)];
				const shiftTypeHe = shiftType === 'day' ? 'יום' : 'לילה';
				return `${hebrewDay} - ${shiftTypeHe}`;
			},
		},
	});
</script>

<!DOCTYPE html>
<html lang="he" dir="rtl">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>מערכת בקשות משמרות - Vue.js</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.21/vue.global.prod.min.js"></script>
	</head>
	<body>
		<div id="app">
			<div class="container">
				<div class="header">
					<h1>בקשות משמרות</h1>
					<p>בחרו עד 3 משמרות שאתם לא יכולים להשתבץ בהם</p>
				</div>

				<div class="content">
					<!-- Employee Selection -->
					<div class="employee-selector">
						<h3>בחרו את השם שלכם:</h3>
						<select class="employee-dropdown" v-model="selectedEmployee" @change="loadEmployeeData">
							<option value="">-- בחרו שם --</option>
							<option v-for="employee in employees" :key="employee" :value="employee">{{ employee }}</option>
						</select>
						<select class="employee-dropdown" v-model="selectedNoOfShifts" @change="loadEmployeeData">
							<option value="">-- בחרו כמות משמרות --</option>
							<option v-for="shiftsOption in shifts" :key="shiftsOption" :value="shiftsOption">{{ shiftsOption }}</option>
						</select>
					</div>

					<!-- Deadline Info -->
					<div class="deadline-info">{{ deadlineInfo }}</div>

					<!-- Employee Form -->
					<transition name="fade">
						<div v-if="selectedEmployee" class="employee-form">
							<div class="form-title">{{ selectedEmployee }} - בחירת משמרות</div>

							<div class="alert alert-info">
								<strong>הוראות:</strong> בחרו עד 3 משמרות שאתם <strong>לא יכולים</strong> לעבוד בשבוע הרלוונטי
							</div>

							<div class="shifts-grid">
								<div
									v-for="(shift, index) in availableShifts"
									:key="index"
									class="shift-option"
									:class="{
                                    selected: selectedShifts.includes(shift.id),
                                    disabled: selectedShifts.length >= 3 && !selectedShifts.includes(shift.id)
                                }"
									@click="toggleShift(shift.id)"
								>
									<div class="shift-date">{{ shift.dateStr }}</div>
									<div class="shift-time">{{ shift.type }}</div>
									<div v-if="selectedShifts.includes(shift.id)" class="unavailable-badge">✗</div>
								</div>
							</div>

							<div
								class="counter"
								:class="{
                                'warning': selectedShifts.length === 2,
                                'limit-reached': selectedShifts.length === 3
                            }"
							>
								משמרות לא זמינות: {{ selectedShifts.length }}/3
								<span v-if="selectedShifts.length === 3"> (הגעתם למגבלה)</span>
							</div>

							<div class="form-actions">
								<button class="btn btn-success" @click="submitRequest" :disabled="loading">
									<span v-if="loading" class="loading"></span>
									{{ loading ? 'שולח...' : 'שליחת בקשה' }}
								</button>
								<button class="btn btn-danger" @click="clearSelections" :disabled="loading || selectedShifts.length === 0">
									איפוס בחירות
								</button>
							</div>
						</div>
					</transition>

					<!-- Manager Login -->
					<div class="manager-login">
						<strong>כניסת מנהלים:</strong>
						<input
							type="password"
							v-model="managerPasswordInput"
							placeholder="סיסמת מנהל"
							@keyup.enter="checkManagerAccess"
						/>
						<button class="btn btn-primary" @click="checkManagerAccess" :disabled="!managerPasswordInput">כניסה</button>
						<div v-if="isManager" style="margin-top: 10px; color: #00ff88">✓ מחובר כמנהל</div>
					</div>

					<!-- Manager Panel -->
					<transition name="fade">
						<div v-if="isManager" class="manager-panel">
							<h3>פאנל מנהלים</h3>
							<div class="form-actions">
								<button class="btn btn-primary" @click="loadAllRequests" :disabled="loading">צפייה בכל הבקשות</button>
								<button class="btn" @click="exportAllRequests" :disabled="loading">ייצוא לגוגל שיטס</button>
								<button class="btn btn-danger" @click="clearAllData" :disabled="loading">איפוס כל הנתונים</button>
							</div>

							<div v-if="showRequests" class="requests-list">
								<h4>בקשות לשבוע הרלוונטי:</h4>
								<div v-if="Object.keys(allRequests).length === 0" class="empty-state">אין בקשות עדיין</div>
								<div v-else>
									<div v-for="(requests, employee) in allRequests" :key="employee" class="request-item">
										<div class="request-employee">{{ employee }} ({{ requests.length }}/3 בקשות)</div>
										<div class="request-shifts">
											<span v-if="requests.length === 0" class="available-badge"> זמין לכל המשמרות </span>
											<span v-for="shift in requests" :key="shift" class="request-shift">
												{{ formatShiftForDisplay(shift) }}
											</span>
										</div>
									</div>
								</div>
							</div>
						</div>
					</transition>
				</div>
			</div>
		</div>
	</body>
</html>
<style>
	* {
		margin: 0;
		padding: 0;
		box-sizing: border-box;
	}

	body {
		font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif, 'Arial Hebrew', sans-serif;
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		min-height: 100vh;
		padding: 20px;
		direction: rtl;
	}

	.container {
		max-width: 800px;
		margin: 0 auto;
		background: white;
		border-radius: 15px;
		box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
		overflow: hidden;
	}

	.header {
		background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
		color: white;
		padding: 30px;
		text-align: center;
	}

	.header h1 {
		font-size: 2.5rem;
		margin-bottom: 10px;
		font-weight: 300;
	}

	.header p {
		font-size: 1.1rem;
		opacity: 0.9;
	}

	.content {
		padding: 30px;
	}

	.employee-selector {
		background: #f8f9fa;
		border-radius: 12px;
		padding: 25px;
		margin-bottom: 25px;
		text-align: center;
	}

	.employee-selector h3 {
		margin-bottom: 20px;
		color: #2c3e50;
		font-size: 1.3rem;
	}

	.employee-dropdown {
		width: 100%;
		max-width: 300px;
		padding: 15px;
		border: 2px solid #e9ecef;
		border-radius: 10px;
		font-size: 1.1rem;
		background: white;
		margin-bottom: 20px;
		transition: all 0.3s ease;
	}

	.employee-dropdown:focus {
		outline: none;
		border-color: #4facfe;
		box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
	}

	.manager-login {
		background: linear-gradient(135deg, #74b9ff, #0984e3);
		color: white;
		border-radius: 10px;
		padding: 15px;
		margin-bottom: 20px;
		text-align: center;
	}

	.manager-login input {
		padding: 10px 15px;
		border: 1px solid rgba(255, 255, 255, 0.3);
		border-radius: 8px;
		background: rgba(255, 255, 255, 0.1);
		color: white;
		margin: 0 10px;
	}

	.manager-login input::placeholder {
		color: rgba(255, 255, 255, 0.7);
	}

	.btn {
		background: linear-gradient(135deg, #00b894, #00a085);
		color: white;
		border: none;
		padding: 15px 30px;
		border-radius: 10px;
		font-size: 1.1rem;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.3s ease;
		margin: 10px;
	}

	.btn:hover {
		transform: translateY(-2px);
		box-shadow: 0 10px 20px rgba(0, 184, 148, 0.3);
	}

	.btn:disabled {
		opacity: 0.6;
		cursor: not-allowed;
		transform: none;
	}

	.btn-primary {
		background: linear-gradient(135deg, #4facfe, #00f2fe);
	}

	.btn-primary:hover {
		box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
	}

	.btn-danger {
		background: linear-gradient(135deg, #ff6b6b, #ee5a52);
	}

	.btn-success {
		background: linear-gradient(135deg, #00b894, #00a085);
	}

	.employee-form {
		background: #f8f9fa;
		border-radius: 12px;
		padding: 25px;
		margin-bottom: 25px;
		animation: fadeIn 0.5s ease;
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.form-title {
		font-size: 1.4rem;
		font-weight: 600;
		color: #2c3e50;
		margin-bottom: 20px;
		text-align: center;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 10px;
	}

	.form-title::before {
		content: '👤';
		font-size: 1.2rem;
	}

	.deadline-info {
		background: linear-gradient(135deg, #74b9ff, #0984e3);
		color: white;
		padding: 15px;
		border-radius: 10px;
		margin-bottom: 20px;
		text-align: center;
		font-size: 0.9rem;
	}

	.shifts-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
		gap: 15px;
		margin-bottom: 20px;
	}

	.shift-option {
		background: white;
		border: 2px solid #e9ecef;
		border-radius: 10px;
		padding: 15px;
		cursor: pointer;
		transition: all 0.3s ease;
		text-align: center;
		position: relative;
		user-select: none;
	}

	.shift-option:hover:not(.disabled) {
		border-color: #4facfe;
		transform: translateY(-2px);
	}

	.shift-option.selected {
		background: linear-gradient(135deg, #ff6b6b, #ee5a52);
		color: white;
		border-color: #ff6b6b;
		transform: scale(1.02);
	}

	.shift-option.disabled {
		opacity: 0.5;
		cursor: not-allowed;
		background: #f8f9fa;
	}

	.shift-date {
		font-weight: 600;
		font-size: 0.9rem;
		margin-bottom: 5px;
		color: #6c757d;
	}

	.shift-option.selected .shift-date {
		color: white;
	}

	.shift-time {
		font-size: 1.1rem;
		font-weight: 500;
	}

	.unavailable-badge {
		position: absolute;
		top: -5px;
		left: -5px;
		background: #ff6b6b;
		color: white;
		border-radius: 50%;
		width: 20px;
		height: 20px;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 12px;
		font-weight: bold;
	}

	.counter {
		text-align: center;
		font-size: 1rem;
		color: #6c757d;
		margin: 20px 0;
		padding: 15px;
		background: #e9ecef;
		border-radius: 8px;
		transition: all 0.3s ease;
	}

	.counter.warning {
		background: #fff3cd;
		color: #856404;
		border: 1px solid #ffeaa7;
	}

	.counter.limit-reached {
		background: #f8d7da;
		color: #721c24;
		border: 1px solid #f5c6cb;
	}

	.alert {
		padding: 15px;
		border-radius: 10px;
		margin: 15px 0;
	}

	.alert-success {
		background: #d4edda;
		color: #155724;
		border: 1px solid #c3e6cb;
	}

	.alert-warning {
		background: #fff3cd;
		color: #856404;
		border: 1px solid #ffeaa7;
	}

	.alert-info {
		background: #cce7ff;
		color: #004085;
		border: 1px solid #99d6ff;
	}

	.form-actions {
		text-align: center;
		margin-top: 30px;
	}

	.manager-panel {
		background: #f8f9fa;
		border-radius: 12px;
		padding: 25px;
		margin-top: 25px;
		animation: fadeIn 0.5s ease;
	}

	.requests-list {
		margin-top: 20px;
	}

	.request-item {
		background: white;
		border-radius: 8px;
		padding: 15px;
		margin-bottom: 10px;
		border-right: 4px solid #4facfe;
		transition: all 0.3s ease;
	}

	.request-item:hover {
		transform: translateX(-5px);
		box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
	}

	.request-employee {
		font-weight: 600;
		color: #2c3e50;
		margin-bottom: 8px;
	}

	.request-shifts {
		display: flex;
		flex-wrap: wrap;
		gap: 8px;
	}

	.request-shift {
		background: #ffebee;
		color: #c62828;
		padding: 4px 8px;
		border-radius: 15px;
		font-size: 0.85rem;
		border: 1px solid #ffcdd2;
	}

	.available-badge {
		background: #e8f5e8;
		color: #2e7d32;
		padding: 4px 8px;
		border-radius: 15px;
		font-size: 0.85rem;
		border: 1px solid #c8e6c9;
		font-weight: 600;
	}

	.empty-state {
		text-align: center;
		color: #6c757d;
		font-style: italic;
		padding: 30px;
	}

	.fade-enter-active,
	.fade-leave-active {
		transition: opacity 0.5s ease;
	}

	.fade-enter-from,
	.fade-leave-to {
		opacity: 0;
	}

	.loading {
		display: inline-block;
		width: 20px;
		height: 20px;
		border: 3px solid #f3f3f3;
		border-top: 3px solid #4facfe;
		border-radius: 50%;
		animation: spin 1s linear infinite;
	}

	@keyframes spin {
		0% {
			transform: rotate(0deg);
		}
		100% {
			transform: rotate(360deg);
		}
	}
</style>
