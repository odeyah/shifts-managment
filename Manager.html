<!DOCTYPE html>
<html lang="he" dir="rtl">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>מערכת בקשות משמרות - מנהלים</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				padding: 20px;
				direction: rtl;
			}

			.container {
				max-width: 1000px;
				margin: 0 auto;
				background: white;
				border-radius: 15px;
				box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
				overflow: hidden;
			}

			.header {
				background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
				color: white;
				padding: 30px;
				text-align: center;
			}

			.header h1 {
				font-size: 2.5rem;
				margin-bottom: 10px;
				font-weight: 300;
			}

			.header p {
				font-size: 1.1rem;
				opacity: 0.9;
			}

			.content {
				padding: 30px;
			}

			.login-section {
				background: #f8f9fa;
				border-radius: 12px;
				padding: 25px;
				margin-bottom: 25px;
				text-align: center;
			}

			.login-input {
				padding: 12px 20px;
				border: 2px solid #e9ecef;
				border-radius: 8px;
				font-size: 1.1rem;
				margin: 0 10px;
				width: 200px;
			}

			.login-input:focus {
				outline: none;
				border-color: #e17055;
				box-shadow: 0 0 0 3px rgba(225, 112, 85, 0.1);
			}

			.btn {
				background: linear-gradient(135deg, #00b894, #00a085);
				color: white;
				border: none;
				padding: 12px 25px;
				border-radius: 8px;
				font-size: 1rem;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
				margin: 5px;
			}

			.btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 8px 15px rgba(0, 184, 148, 0.3);
			}

			.btn:disabled {
				opacity: 0.6;
				cursor: not-allowed;
				transform: none;
			}

			.btn-primary {
				background: linear-gradient(135deg, #e17055, #d63031);
			}

			.btn-primary:hover {
				box-shadow: 0 8px 15px rgba(225, 112, 85, 0.3);
			}

			.btn-danger {
				background: linear-gradient(135deg, #ff6b6b, #ee5a52);
			}

			.btn-export {
				background: linear-gradient(135deg, #74b9ff, #0984e3);
			}

			.manager-panel {
				background: #f8f9fa;
				border-radius: 12px;
				padding: 25px;
				margin-top: 25px;
				display: none;
				opacity: 0;
				transform: translateY(20px);
				transition: all 0.5s ease;
			}

			.manager-panel.show {
				display: block;
				opacity: 1;
				transform: translateY(0);
			}

			.manager-panel h3 {
				color: #2c3e50;
				margin-bottom: 20px;
				font-size: 1.5rem;
			}

			.week-selector {
				background: white;
				border-radius: 8px;
				padding: 15px;
				margin-bottom: 20px;
			}

			.week-selector select {
				padding: 10px 15px;
				border: 2px solid #e9ecef;
				border-radius: 8px;
				font-size: 1rem;
				background: white;
				margin: 0 10px;
			}

			.requests-list {
				margin-top: 20px;
			}

			.requests-table {
				width: 100%;
				border-collapse: collapse;
				background: white;
				border-radius: 8px;
				overflow: hidden;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
			}

			.requests-table th {
				background: linear-gradient(135deg, #e17055, #d63031);
				color: white;
				padding: 12px;
				text-align: center;
				font-weight: 600;
			}

			.requests-table td {
				padding: 12px;
				text-align: center;
				border-bottom: 1px solid #eee;
			}

			.requests-table tr:hover {
				background: #f8f9fa;
			}

			.available {
				background: #d4edda;
				color: #155724;
				padding: 4px 8px;
				border-radius: 15px;
				font-size: 0.85rem;
				font-weight: 600;
			}

			.unavailable {
				background: #f8d7da;
				color: #721c24;
				padding: 4px 8px;
				border-radius: 15px;
				font-size: 0.85rem;
				font-weight: 600;
			}

			.empty-state {
				text-align: center;
				color: #6c757d;
				font-style: italic;
				padding: 40px;
				background: white;
				border-radius: 8px;
			}

			.success-message {
				background: #d4edda;
				color: #155724;
				padding: 10px 15px;
				border-radius: 8px;
				margin: 10px 0;
				border: 1px solid #c3e6cb;
			}

			.loading {
				display: inline-block;
				width: 20px;
				height: 20px;
				border: 3px solid #f3f3f3;
				border-top: 3px solid #e17055;
				border-radius: 50%;
				animation: spin 1s linear infinite;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			.export-info {
				background: #cce7ff;
				color: #004085;
				padding: 15px;
				border-radius: 8px;
				margin: 15px 0;
				border: 1px solid #99d6ff;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>🔧 פאנל מנהלים</h1>
				<p>צפייה וניהול בקשות משמרות עובדים</p>
			</div>

			<div class="content">
				<!-- Manager Login -->
				<div class="login-section" id="loginSection">
					<h3>כניסת מנהלים</h3>
					<input
						type="password"
						id="passwordInput"
						class="login-input"
						placeholder="סיסמת מנהל"
						onkeyup="if(event.key==='Enter') checkPassword()"
					/>
					<button class="btn btn-primary" onclick="checkPassword()">כניסה</button>
				</div>

				<!-- Manager Panel -->
				<div class="manager-panel" id="managerPanel">
					<h3>ניהול בקשות משמרות</h3>

					<!-- Week Selector -->
					<div class="week-selector">
						<label>בחר שבוע לצפייה:</label>
						<select id="weekSelect" onchange="loadRequestsForWeek()">
							<option value="">-- בחר שבוע --</option>
						</select>
						<button class="btn btn-primary" onclick="loadAllWeeks()">רענן רשימת שבועות</button>
					</div>

					<!-- Action Buttons -->
					<div style="text-align: center; margin: 20px 0">
						<button class="btn btn-primary" onclick="loadCurrentWeekRequests()">צפה בבקשות לשבוע הנוכח</button>
						<button class="btn btn-export" onclick="exportToCSV()">ייצוא לגוגל שיטס</button>
						<button class="btn btn-danger" onclick="clearAllData()">מחק את כל הנתונים</button>
						<button class="btn" onclick="logout()" style="background: linear-gradient(135deg, #6c757d, #495057)">
							התנתק
						</button>
					</div>

					<!-- Requests Display -->
					<div class="requests-list" id="requestsList">
						<!-- Requests will be loaded here -->
					</div>
				</div>
			</div>
		</div>

		<script>
			// Security Configuration - Change these before deployment
			const SECURITY_CONFIG = {
				// Enable URL password (main security method)
				useUrlPassword: true,
				urlPasswordParam: 'pwd',

				// Your secret passwords (change these!)
				validPasswords: ['Manager2024!', 'SecureAdmin123', 'ShiftManager2024'],

				// Optional: Time restrictions
				restrictByTime: false,
				allowedHours: { start: 8, end: 18 }, // 8 AM to 6 PM

				// Debug mode (set to false for production)
				showPasswordHints: true,
			};

			// Get current timestamp for session validation
			const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
			let sessionStartTime = null;
			const EMPLOYEES = [
				'יוסי כהן',
				'רחל לוי',
				'משה אברהם',
				'שרה דוד',
				'דני מלכה',
				'מירי רוזן',
				'אבי שמש',
				'טלי ברון',
				'נתן גולד',
				'מיכל ברק',
				'רון שחר',
				'תמר נוי',
			];
			const SHORT_HEBREW_DAYS = ["א'", "ב'", "ג'", "ד'", "ה'", "ו'", "ש'"];
			const FULL_HEBREW_DAYS = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];

			let currentWeekKey = '';
			let currentWeekDates = [];

			// Enhanced password checking with multiple security layers
			function checkPassword() {
				const inputPassword = document.getElementById('passwordInput').value;

				// Check if session has expired
				if (sessionStartTime && Date.now() - sessionStartTime > SESSION_TIMEOUT) {
					alert('תקופת הגישה פגה. אנא התחבר שנית.');
					logout();
					return;
				}

				let isValidPassword = false;

				// Check URL parameter password
				if (SECURITY_CONFIG.useUrlPassword) {
					const urlParams = new URLSearchParams(window.location.search);
					const urlPassword = urlParams.get(SECURITY_CONFIG.urlPasswordParam);
					if (urlPassword && inputPassword === urlPassword) {
						isValidPassword = true;
					}
				}

				// Check against multiple valid passwords
				if (SECURITY_CONFIG.validPasswords.includes(inputPassword)) {
					isValidPassword = true;
				}

				// Time-based restriction
				if (SECURITY_CONFIG.restrictByTime) {
					const currentHour = new Date().getHours();
					if (currentHour < SECURITY_CONFIG.allowedHours.start || currentHour > SECURITY_CONFIG.allowedHours.end) {
						alert(
							'גישה אפשרית רק בין השעות ' +
								SECURITY_CONFIG.allowedHours.start +
								':00 ל-' +
								SECURITY_CONFIG.allowedHours.end +
								':00',
						);
						return;
					}
				}

				if (isValidPassword) {
					sessionStartTime = Date.now();
					document.getElementById('loginSection').style.display = 'none';
					document.getElementById('managerPanel').classList.add('show');
					loadAllWeeks();
					loadCurrentWeekRequests();

					// Start session timer
					startSessionTimer();

					alert('התחברת בהצלחה כמנהל!');

					// Clear password field for security
					document.getElementById('passwordInput').value = '';

					// Remove password from URL for security
					if (SECURITY_CONFIG.useUrlPassword) {
						const url = new URL(window.location);
						url.searchParams.delete(SECURITY_CONFIG.urlPasswordParam);
						window.history.replaceState({}, document.title, url);
					}
				} else {
					// Add delay to prevent brute force
					setTimeout(() => {
						alert('סיסמה שגויה');
						document.getElementById('passwordInput').value = '';
					}, 1000);

					// Show hint if enabled
					if (SECURITY_CONFIG.showPasswordHints) {
						console.log('Hint: Check the URL parameters or contact admin');
					}
				}
			}

			// Session management
			function startSessionTimer() {
				// Check session every minute
				setInterval(() => {
					if (sessionStartTime && Date.now() - sessionStartTime > SESSION_TIMEOUT) {
						alert('תקופת הגישה פגה מטעמי אבטחה');
						logout();
					}
				}, 60000);
			}

			// Logout function
			function logout() {
				sessionStartTime = null;
				document.getElementById('loginSection').style.display = 'block';
				document.getElementById('managerPanel').classList.remove('show');
				document.getElementById('passwordInput').value = '';

				// Clear any sensitive data from memory
				currentWeekKey = '';
				currentWeekDates = [];
			}

			// Load all available weeks
			function loadAllWeeks() {
				try {
					const allRequests = JSON.parse(localStorage.getItem('employeeRequests') || '{}');
					const weekSelect = document.getElementById('weekSelect');

					// Clear existing options
					weekSelect.innerHTML = '<option value="">-- בחר שבוע --</option>';

					// Debug: Show what's in localStorage
					console.log('All requests data:', allRequests);
					console.log('Available weeks:', Object.keys(allRequests));

					// Add options for each week that has data
					Object.keys(allRequests).forEach(weekKey => {
						const option = document.createElement('option');
						option.value = weekKey;
						option.textContent = formatWeekKey(weekKey);
						weekSelect.appendChild(option);

						// Debug: Show data for each week
						console.log(`Week ${weekKey} data:`, allRequests[weekKey]);
					});
				} catch (error) {
					console.error('Error loading weeks:', error);
				}
			}

			// Format week key for display
			function formatWeekKey(weekKey) {
				if (weekKey === 'current') return 'שבוע נוכחי';

				try {
					const [year, month, day] = weekKey.split('-');
					const date = new Date(parseInt(year), parseInt(month), parseInt(day));
					return `שבוע של ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
				} catch (error) {
					return weekKey;
				}
			}

			// Load current week requests
			function loadCurrentWeekRequests() {
				const now = new Date();
				const currentDay = now.getDay();
				const currentHour = now.getHours();

				// Determine which week to show
				const passedDeadline = currentDay > 3 || (currentDay === 3 && currentHour >= 10);
				let targetWeek;

				if (passedDeadline) {
					targetWeek = getWeekAfterNext();
				} else {
					targetWeek = getNextWeekDates();
				}

				currentWeekDates = targetWeek;
				currentWeekKey = generateWeekKey(targetWeek[0]);

				loadRequestsForWeek(currentWeekKey);
			}

			// Load requests for selected week
			function loadRequestsForWeek(weekKey = null) {
				if (!weekKey) {
					weekKey = document.getElementById('weekSelect').value;
				}

				if (!weekKey) {
					document.getElementById('requestsList').innerHTML = '<div class="empty-state">בחר שבוע מהרשימה הנפתחת</div>';
					return;
				}

				try {
					const allRequests = JSON.parse(localStorage.getItem('employeeRequests') || '{}');
					const weekRequests = allRequests[weekKey] || {};

					// Debug: Show what we're trying to load
					console.log(`Loading requests for week: ${weekKey}`);
					console.log('Week requests data:', weekRequests);
					console.log('Employee names in data:', Object.keys(weekRequests));

					// If we don't have dates for this week, generate them
					if (!currentWeekDates.length && weekKey !== 'current') {
						currentWeekDates = generateWeekDates(weekKey);
					}

					// Show raw data in a debug section
					let debugInfo = `
                    <div style="background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-family: monospace; font-size: 0.9rem;">
                        <h5>🔍 Debug Info:</h5>
                        <p><strong>Week Key:</strong> ${weekKey}</p>
                        <p><strong>Total weeks in storage:</strong> ${Object.keys(allRequests).length}</p>
                        <p><strong>Employees in this week:</strong> ${Object.keys(weekRequests).length}</p>
                        <p><strong>Employee names found:</strong> ${Object.keys(weekRequests).join(', ') || 'None'}</p>
                        <p><strong>Expected employees:</strong> ${EMPLOYEES.join(', ')}</p>
                    </div>
                `;

					document.getElementById('requestsList').innerHTML = debugInfo;

					displayRequests(weekRequests, weekKey);
					currentWeekKey = weekKey;
				} catch (error) {
					console.error('Error loading requests:', error);
					document.getElementById(
						'requestsList',
					).innerHTML = `<div class="empty-state">שגיאה בטעינת הנתונים: ${error.message}</div>`;
				}
			}

			// Display requests in a table
			function displayRequests(weekRequests, weekKey) {
				const requestsList = document.getElementById('requestsList');

				// Filter to only employees who have submitted forms
				const employeesWithSubmissions = Object.keys(weekRequests).filter(employee => weekRequests[employee] !== undefined);

				if (employeesWithSubmissions.length === 0) {
					requestsList.innerHTML = `
                    <div class="empty-state">
                        <h4>אין בקשות עבור השבוע הנבחר</h4>
                        <p>לא נמצאו בקשות משמרות עבור ${formatWeekKey(weekKey)}</p>
                    </div>
                `;
					return;
				}

				let tableHTML = `
                <h4>בקשות שהוגשו עבור ${formatWeekKey(weekKey)} (${employeesWithSubmissions.length} עובדים):</h4>
                <table class="requests-table">
                    <thead>
                        <tr>
                            <th>שם עובד</th>
            `;

				// Add day headers
				currentWeekDates.forEach((date, index) => {
					const hebrewDay = SHORT_HEBREW_DAYS[index];
					const dateStr = `${hebrewDay} ${date.getDate()}/${date.getMonth() + 1}`;
					tableHTML += `<th>${dateStr}<br>יום</th><th>${dateStr}<br>לילה</th>`;
				});

				tableHTML += `
                            <th>סה"כ לא זמין</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

				// Add employee rows - only those who submitted
				employeesWithSubmissions.forEach(employee => {
					const employeeShifts = weekRequests[employee] || [];

					tableHTML += `<tr><td><strong>${employee}</strong></td>`;

					// Add status for each shift
					currentWeekDates.forEach((date, dayIndex) => {
						const dayId = `${dayIndex}-day`;
						const nightId = `${dayIndex}-night`;

						const dayStatus = employeeShifts.includes(dayId)
							? '<span class="unavailable">לא זמין</span>'
							: '<span class="available">זמין</span>';

						const nightStatus = employeeShifts.includes(nightId)
							? '<span class="unavailable">לא זמין</span>'
							: '<span class="available">זמין</span>';

						tableHTML += `<td>${dayStatus}</td><td>${nightStatus}</td>`;
					});

					// Add total unavailable shifts count
					const unavailableCount = employeeShifts.length;
					const countColor = unavailableCount === 0 ? 'available' : 'unavailable';
					tableHTML += `<td><span class="${countColor}">${unavailableCount}</span></td>`;

					tableHTML += `</tr>`;
				});

				tableHTML += `</tbody></table>`;

				// Add summary info
				tableHTML += `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h5 style="color: #2c3e50; margin-bottom: 10px;">סיכום:</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>📝 <strong>עובדים שהגישו בקשות:</strong> ${employeesWithSubmissions.length}</div>
                        <div>👥 <strong>סה"כ עובדים במערכת:</strong> ${EMPLOYEES.length}</div>
                        <div>⏳ <strong>עובדים שלא הגישו:</strong> ${
													EMPLOYEES.length - employeesWithSubmissions.length
												}</div>
                    </div>
                </div>
            `;

				// Show employees who haven't submitted if any
				const employeesWithoutSubmissions = EMPLOYEES.filter(emp => !employeesWithSubmissions.includes(emp));
				if (employeesWithoutSubmissions.length > 0) {
					tableHTML += `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h5 style="color: #856404; margin-bottom: 10px;">⚠️ עובדים שטרם הגישו בקשות:</h5>
                        <div style="color: #856404;">
                            ${employeesWithoutSubmissions.join(', ')}
                        </div>
                    </div>
                `;
				}

				requestsList.innerHTML = tableHTML;
			}

			// Export to CSV
			function exportToCSV() {
				if (!currentWeekKey) {
					alert('אנא בחר שבוע תחילה');
					return;
				}

				try {
					const allRequests = JSON.parse(localStorage.getItem('employeeRequests') || '{}');
					const weekRequests = allRequests[currentWeekKey] || {};

					let csvContent = 'שם,';

					// Create headers
					currentWeekDates.forEach((date, index) => {
						const hebrewDay = SHORT_HEBREW_DAYS[index];
						const dateStr = `${hebrewDay} ${date.getDate()}/${date.getMonth() + 1}`;
						csvContent += `"${dateStr} יום","${dateStr} לילה",`;
					});
					csvContent = csvContent.slice(0, -1) + '\n';

					// Add employee data
					EMPLOYEES.forEach(employee => {
						const employeeShifts = weekRequests[employee] || [];
						csvContent += `"${employee}",`;

						currentWeekDates.forEach((date, dayIndex) => {
							const dayId = `${dayIndex}-day`;
							const nightId = `${dayIndex}-night`;

							const dayStatus = employeeShifts.includes(dayId) ? 'לא זמין' : 'זמין';
							const nightStatus = employeeShifts.includes(nightId) ? 'לא זמין' : 'זמין';

							csvContent += `"${dayStatus}","${nightStatus}",`;
						});

						csvContent = csvContent.slice(0, -1) + '\n';
					});

					// Copy to clipboard
					navigator.clipboard
						.writeText(csvContent)
						.then(() => {
							document
								.getElementById('requestsList')
								.insertAdjacentHTML(
									'afterbegin',
									'<div class="success-message">✅ הנתונים הועתקו للוח! תוכל כעת להדביק אותם בגוגל שיטס או אקסל</div>',
								);

							// Remove success message after 5 seconds
							setTimeout(() => {
								const successMsg = document.querySelector('.success-message');
								if (successMsg) successMsg.remove();
							}, 5000);
						})
						.catch(() => {
							// Fallback for older browsers
							const textArea = document.createElement('textarea');
							textArea.value = csvContent;
							document.body.appendChild(textArea);
							textArea.select();
							document.execCommand('copy');
							document.body.removeChild(textArea);

							alert('הנתונים הועתקו ללוח! (שיטה חלופית)');
						});
				} catch (error) {
					console.error('Export error:', error);
					alert('שגיאה בייצוא הנתונים');
				}
			}

			// Clear all data
			function clearAllData() {
				if (confirm('האם אתה בטוח שברצונך למחוק את כל נתוני הבקשות? פעולה זו אינה ניתנת לביטול!')) {
					if (confirm('זו פעולה סופית! כל הבקשות של כל העובדים יימחקו. האם להמשיך?')) {
						localStorage.removeItem('employeeRequests');
						document.getElementById('requestsList').innerHTML =
							'<div class="success-message">✅ כל הנתונים נמחקו בהצלחה!</div>';
						loadAllWeeks(); // Refresh week list
						alert('כל הנתונים נמחקו בהצלחה!');
					}
				}
			}

			// Date utility functions
			function getNextWeekDates() {
				const today = new Date();
				const nextSunday = new Date(today);
				nextSunday.setDate(today.getDate() + (7 - today.getDay()));

				const dates = [];
				for (let i = 0; i < 7; i++) {
					const date = new Date(nextSunday);
					date.setDate(nextSunday.getDate() + i);
					dates.push(date);
				}
				return dates;
			}

			function getWeekAfterNext() {
				const today = new Date();
				const weekAfterNextSunday = new Date(today);
				weekAfterNextSunday.setDate(today.getDate() + (14 - today.getDay()));

				const dates = [];
				for (let i = 0; i < 7; i++) {
					const date = new Date(weekAfterNextSunday);
					date.setDate(weekAfterNextSunday.getDate() + i);
					dates.push(date);
				}
				return dates;
			}

			function generateWeekKey(firstDate) {
				return `${firstDate.getFullYear()}-${firstDate.getMonth()}-${firstDate.getDate()}`;
			}

			function generateWeekDates(weekKey) {
				try {
					const [year, month, day] = weekKey.split('-');
					const startDate = new Date(parseInt(year), parseInt(month), parseInt(day));

					const dates = [];
					for (let i = 0; i < 7; i++) {
						const date = new Date(startDate);
						date.setDate(startDate.getDate() + i);
						dates.push(date);
					}
					return dates;
				} catch (error) {
					console.error('Error generating week dates:', error);
					return getNextWeekDates(); // Fallback
				}
			}

			// Initialize page with URL password check
			window.addEventListener('load', function () {
				console.log('Manager panel loaded');

				// Check for URL password on page load
				const urlParams = new URLSearchParams(window.location.search);
				const urlPassword = urlParams.get(SECURITY_CONFIG.urlPasswordParam);

				if (urlPassword && SECURITY_CONFIG.useUrlPassword) {
					// Auto-fill password field
					document.getElementById('passwordInput').value = urlPassword;

					// Show login hint
					const loginSection = document.getElementById('loginSection');
					loginSection.insertAdjacentHTML(
						'beforeend',
						`
                    <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 0.9rem;">
                        🔑 זוהה סיסמה ב-URL. לחץ "כניסה" או Enter להתחברות.
                    </div>
                `,
					);

					// Optional: Auto-login after 2 seconds
					setTimeout(() => {
						if (document.getElementById('passwordInput').value === urlPassword) {
							checkPassword();
						}
					}, 2000);
				}

				// Focus on password input
				document.getElementById('passwordInput').focus();
			});
		</script>
	</body>
</html>
